// Code generated by user config generator. DO NOT EDIT.

package metrics

import (
	"context"
	"encoding/json"
	"testing"

	"github.com/google/go-cmp/cmp"
	"github.com/hashicorp/terraform-plugin-framework/diag"
	"github.com/stretchr/testify/require"

	"github.com/aiven/terraform-provider-aiven/internal/schemautil"
)

const allFields = `{
    "database": "foo",
    "retention_days": 1,
    "ro_username": "foo",
    "source_mysql": {
        "telegraf": {
            "gather_event_waits": true,
            "gather_file_events_stats": true,
            "gather_index_io_waits": true,
            "gather_info_schema_auto_inc": true,
            "gather_innodb_metrics": true,
            "gather_perf_events_statements": true,
            "gather_process_list": true,
            "gather_slave_status": true,
            "gather_table_io_waits": true,
            "gather_table_lock_waits": true,
            "gather_table_schema": true,
            "perf_events_statements_digest_text_limit": 1,
            "perf_events_statements_limit": 1,
            "perf_events_statements_time_limit": 1
        }
    },
    "username": "foo"
}`
const updateOnlyFields = `{
    "database": "foo",
    "retention_days": 1,
    "ro_username": "foo",
    "source_mysql": {
        "telegraf": {
            "gather_event_waits": true,
            "gather_file_events_stats": true,
            "gather_index_io_waits": true,
            "gather_info_schema_auto_inc": true,
            "gather_innodb_metrics": true,
            "gather_perf_events_statements": true,
            "gather_process_list": true,
            "gather_slave_status": true,
            "gather_table_io_waits": true,
            "gather_table_lock_waits": true,
            "gather_table_schema": true,
            "perf_events_statements_digest_text_limit": 1,
            "perf_events_statements_limit": 1,
            "perf_events_statements_time_limit": 1
        }
    },
    "username": "foo"
}`

func TestUserConfig(t *testing.T) {
	cases := []struct {
		name   string
		source string
		expect string
		create bool
	}{
		{
			name:   "fields to create resource",
			source: allFields,
			expect: allFields,
			create: true,
		},
		{
			name:   "only fields to update resource",
			source: allFields,
			expect: updateOnlyFields, // usually, fewer fields
			create: false,
		},
	}

	ctx := context.Background()
	diags := make(diag.Diagnostics, 0)
	for _, opt := range cases {
		t.Run(opt.name, func(t *testing.T) {
			dto := new(dtoUserConfig)
			err := json.Unmarshal([]byte(opt.source), dto)
			require.NoError(t, err)

			// From json to TF
			tfo := flattenUserConfig(ctx, diags, dto)
			require.Empty(t, diags)

			// From TF to json
			config := expandUserConfig(ctx, diags, tfo)
			require.Empty(t, diags)

			// Run specific marshal (create or update resource)
			dtoConfig, err := schemautil.MarshalUserConfig(config, opt.create)
			require.NoError(t, err)

			// Compares that output is strictly equal to the input
			// If so, the flow is valid
			b, err := json.MarshalIndent(dtoConfig, "", "    ")
			require.NoError(t, err)
			require.Empty(t, cmp.Diff(opt.expect, string(b)))
		})
	}
}
